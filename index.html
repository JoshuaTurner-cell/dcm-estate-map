<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCM Estate</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* CONFIG */
        :root {
            --bg: #0f1115; --panel: #181b21; --border: #2d333b; --text: #c9d1d9; --text-head: #ffffff;
            --accent: #3b82f6; --accent-hover: #2563eb;
        }
        
        body { margin: 0; font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        #sidebar { width: 420px; background-color: var(--panel); padding: 20px; display: flex; flex-direction: column; border-right: 1px solid var(--border); box-shadow: 4px 0 20px rgba(0,0,0,0.6); z-index: 1000; overflow-y: auto; }
        h1 { margin: 0 0 15px 0; font-size: 1.5rem; font-weight: 700; color: var(--text-head); letter-spacing: -0.5px; }
        
        /* TOP CONTROLS */
        #top-controls { position: absolute; top: 15px; right: 15px; z-index: 5000; display: flex; gap: 10px; }
        .bubble-btn {
            background-color: rgba(30, 30, 30, 0.6); color: rgba(255, 255, 255, 0.6);
            padding: 6px 14px; border-radius: 30px; font-size: 0.75rem; font-weight: 600;
            text-decoration: none; backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.2s ease; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .bubble-btn:hover { background-color: var(--accent); color: #fff; transform: translateY(-2px); border-color: var(--accent); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        /* HELP MODAL */
        #help-modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(4px); 
        }
        #help-box { 
            background: var(--panel); border: 1px solid var(--border); width: 500px; max-height: 80vh; overflow-y: auto; 
            padding: 30px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.9); 
        }
        #help-box h2 { margin-top: 0; color: #fff; border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 20px;}
        
        .help-step { margin-bottom: 20px; display: flex; gap: 15px; }
        .step-num { 
            background: var(--accent); color: #fff; width: 24px; height: 24px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem; flex-shrink: 0; margin-top: 2px;
        }
        .step-content strong { color: #fff; display: block; margin-bottom: 4px; font-size: 0.95rem; }
        .step-content p { margin: 0; font-size: 0.85rem; color: #9ca3af; line-height: 1.5; }
        .tip-box { 
            background: rgba(59, 130, 246, 0.1); border-left: 3px solid var(--accent); 
            padding: 10px; margin-top: 5px; font-size: 0.8rem; color: #bfdbfe; border-radius: 0 4px 4px 0;
        }

        /* STATS GRID */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px; }
        .stat-card { background: #22272e; border: 1px solid var(--border); padding: 12px; border-radius: 6px; }
        .stat-card.wide { grid-column: span 2; }
        .stat-val { display: block; font-size: 1.1rem; font-weight: 700; color: #fff; }
        .stat-label { font-size: 0.65rem; color: #8b949e; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }
        .highlight-stat { color: #4facfe; }
        .region-list { font-size: 0.75rem; color: #fff; line-height: 1.4; max-height: 60px; overflow-y: auto; }

        /* CONTROLS */
        .control-section { border-top: 1px solid var(--border); padding-top: 15px; margin-top: 5px; }
        label { display: block; font-size: 0.7rem; font-weight: 600; margin-bottom: 6px; color: #8b949e; text-transform: uppercase; }
        input, select { width: 100%; padding: 8px; background: #0d1117; border: 1px solid #30363d; color: #fff; border-radius: 5px; box-sizing: border-box; margin-bottom: 8px; font-size: 0.9rem; }
        input:focus, select:focus { outline: none; border-color: #4facfe; }
        
        button { width: 100%; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; background: #2ea043; color: white; transition: 0.2s; }
        button:hover { background: #3fb950; }
        .btn-reset { background: transparent; border: 1px solid var(--border); color: var(--text); margin-top: 5px; }
        .btn-reset:hover { background: #21262d; }

        /* LIST & MAP */
        #list-container { margin-top: 15px; border-top: 1px solid var(--border); }
        .list-item { padding: 10px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.1s; display: flex; align-items: center; gap: 10px;}
        .list-item:hover { background: #21262d; }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; flex-shrink: 0; }
        
        #map { flex-grow: 1; height: 100%; background: var(--bg); position: relative; }
        
        /* CLUSTERS */
        .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large { background-color: rgba(59, 130, 246, 0.6); }
        .marker-cluster-small div, .marker-cluster-medium div, .marker-cluster-large div { background-color: #1e40af; color: #fff; font-family: 'Inter', sans-serif; font-weight: bold; }

        /* POPUP */
        .leaflet-popup-content-wrapper { background: var(--panel); color: var(--text); border: 1px solid var(--border); font-family: 'Inter', sans-serif; border-radius: 6px; }
        .leaflet-popup-tip { background: var(--panel); }
        .popup-row { display: flex; justify-content: space-between; margin-bottom: 3px; font-size: 0.85rem; }
        .popup-label { color: #8b949e; }
        .popup-val { font-weight: 600; color: #fff; text-align: right;}
    </style>
</head>
<body>

    <div id="top-controls">
        <a href="mailto:Joshua.Turner@dcm.co.uk" class="bubble-btn" title="Email Josh">Made by Josh</a>
        <div class="bubble-btn" onclick="toggleHelp()">?</div>
    </div>

    <div id="help-modal" onclick="toggleHelp()">
        <div id="help-box" onclick="event.stopPropagation()">
            <h2>Quick Start Guide</h2>
            
            <div class="help-step">
                <div class="step-num">1</div>
                <div class="step-content">
                    <strong>Load Data</strong>
                    <p>The map starts blank. Upload your <b>Estate Details.csv</b> to visualize the network.</p>
                </div>
            </div>

            <div class="help-step">
                <div class="step-num">2</div>
                <div class="step-content">
                    <strong>Smart Search</strong>
                    <p>You can type a Postcode <i>(e.g., "SW1A 1AA")</i> <b>OR</b> simply <b>Right-Click</b> anywhere on the map to pin a search location.</p>
                    <div class="tip-box">
                        <b>Pro Tip:</b> Change the radius unit to <b>"Drive (min)"</b> to see catchment areas based on estimated urban traffic.
                    </div>
                </div>
            </div>

            <div class="help-step">
                <div class="step-num">3</div>
                <div class="step-content">
                    <strong>Analyze Visuals</strong>
                    <p><b>Clusters:</b> Blue circles show site counts in an area.<br>
                    <b>Bubbles:</b> Zoom in to see individual sites. Bubble size represents <b>Weekly Admissions</b>.</p>
                </div>
            </div>

            <div class="help-step">
                <div class="step-num">4</div>
                <div class="step-content">
                    <strong>Export</strong>
                    <p>Click "Export Visible Data" to download a CSV containing <b>only</b> the sites currently visible on your map/filter selection.</p>
                </div>
            </div>

            <button onclick="toggleHelp()" style="width:100%; margin-top:10px;">Close Guide</button>
        </div>
    </div>

    <div id="sidebar">
        <h1>DCM Estate</h1>
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-val" id="stat-count">0</span>
                <span class="stat-label">Sites</span>
            </div>
            <div class="stat-card">
                <span class="stat-val" id="stat-seats">0</span>
                <span class="stat-label">Total Seats</span>
            </div>
            <div class="stat-card">
                <span class="stat-val" id="stat-avg-admit">0</span>
                <span class="stat-label">Avg Weekly Admits</span>
            </div>
            <div class="stat-card">
                <span class="stat-val highlight-stat" id="stat-weight">0</span>
                <span class="stat-label">Total Site Weight</span>
            </div>
            <div class="stat-card wide">
                <div class="region-list" id="stat-regions">-</div>
                <span class="stat-label">Macro Trading Regions</span>
            </div>
        </div>

        <div class="control-section">
            <label>1. Load Data</label>
            <input type="file" id="csv-file" accept=".csv">
            
            <label>2. Filters</label>
            <select id="exhibitor-filter" onchange="applyFilters()"><option value="All">All Exhibitors</option></select>
            <select id="region-filter" onchange="applyFilters()"><option value="All">All Regions</option></select>
            
            <label>3. Radius Search</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="postcode" placeholder="Postcode or Right Click" style="flex: 2;">
                <input type="number" id="radius" value="20" style="width: 60px;">
                <select id="radius-unit" style="width: 100px;">
                    <option value="miles">Miles</option>
                    <option value="drive">Drive (min)</option>
                    <option value="walk">Walk (min)</option>
                </select>
            </div>
            <button onclick="performSearch()">Apply Radius</button>
            <button class="btn-reset" onclick="resetView()">Reset Map</button>
        </div>

        <div id="list-container">
            <div style="text-align:center; padding:20px; font-size:0.8rem; color:#555;">Import CSV to begin</div>
        </div>
        
        <button class="btn-reset" style="margin-top:auto" onclick="exportData()">Export Visible Data</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script>
        const map = L.map('map', { attributionControl: false }).setView([54.0, -2.0], 6);
        L.control.attribution({ prefix: false }).addTo(map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO &copy; OSM', maxZoom: 19 }).addTo(map);

        let allData = [];
        let filteredData = [];
        let markers = L.markerClusterGroup({
            showCoverageOnHover: true, zoomToBoundsOnClick: true, spiderfyOnMaxZoom: true, removeOutsideVisibleBounds: true, maxClusterRadius: 45
        }).addTo(map);

        let userCircle = null;
        let lastClickedCoords = null;

        function getBrandColor(name) {
            const n = (name || '').toLowerCase();
            if(n.includes('odeon')) return '#0066ff';
            if(n.includes('vue')) return '#ff9900';
            if(n.includes('picturehouse')) return '#8b0000';
            if(n.includes('cineworld')) return '#ff0000';
            if(n.includes('omniplex')) return '#00cc44';
            if(n.includes('light')) return '#9d00ff';
            return '#ffd700';
        }

        document.getElementById('csv-file').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            Papa.parse(file, { header: true, skipEmptyLines: true, complete: function(res) { allData = res.data; populateDropdowns(); resetView(); } });
        });

        // RIGHT CLICK HANDLER
        map.on('contextmenu', function(e) {
            if(allData.length === 0) return alert("Please load data first.");
            lastClickedCoords = { lat: e.latlng.lat, lng: e.latlng.lng };
            document.getElementById('postcode').value = "Pinned Location";
            runRadiusSearch(lastClickedCoords.lat, lastClickedCoords.lng);
        });

        function toggleHelp() {
            const el = document.getElementById('help-modal');
            el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
        }

        function updateMap(data, fitBounds = false) {
            markers.clearLayers();
            const bounds = L.latLngBounds();

            data.forEach(row => {
                const lat = parseFloat(row.Latitude);
                const lng = parseFloat(row.Longitude);
                const seats = parseInt(row.Seats) || 0;
                const admits = parseInt(row['Weekly Admissions']) || 0; // Use Admissions for Bubble Size
                
                if(!isNaN(lat) && !isNaN(lng)) {
                    bounds.extend([lat, lng]);
                    const color = getBrandColor(row.Exhibitor);
                    
                    // BUBBLE SIZE LOGIC (Based on Weekly Admits)
                    // Scale factor: sqrt(admits) * 0.4. 
                    // Example: 2000 admits -> 45 * 0.4 = 18px radius
                    let r = Math.sqrt(admits) * 0.4; 
                    if(r < 6) r = 6; // Minimum size
                    if(r > 40) r = 40; // Max cap so they don't cover map
                    
                    const marker = L.circleMarker([lat, lng], {
                        radius: r, fillColor: color, color: '#fff', weight: 1, fillOpacity: 0.8
                    });

                    marker.bindPopup(`
                        <div style="min-width:200px">
                            <strong style="font-size:1rem; display:block; margin-bottom:2px;">${row.Site}</strong>
                            <span style="color:${color}; font-weight:bold; font-size:0.9rem;">${row.Exhibitor}</span>
                            <hr style="border:0; border-top:1px solid #444; margin:8px 0;">
                            <div class="popup-row"><span class="popup-label">Wkly Adms</span><span class="popup-val">${admits.toLocaleString()}</span></div>
                            <div class="popup-row"><span class="popup-label">Seats</span><span class="popup-val">${seats}</span></div>
                            <div class="popup-row"><span class="popup-label">Screens</span><span class="popup-val">${row['No. of Screens'] || '-'}</span></div>
                            <div class="popup-row"><span class="popup-label">Weight</span><span class="popup-val">${row.Weight || '0'}</span></div>
                            <hr style="border:0; border-top:1px solid #333; margin:5px 0;">
                            <div class="popup-row"><span class="popup-label">Macro</span><span class="popup-val">${row['Macro Trading Region'] || '-'}</span></div>
                        </div>
                    `);
                    markers.addLayer(marker);
                }
            });

            if(fitBounds && data.length > 0) {
                if(userCircle) {
                    map.fitBounds(userCircle.getBounds());
                } else {
                    map.fitBounds(bounds, { padding: [50, 50], maxZoom: 14 });
                }
            }
            updateStats(data);
            updateList(data);
        }

        function updateStats(data) {
            document.getElementById('stat-count').innerText = data.length;
            const totalSeats = data.reduce((sum, item) => sum + (parseInt(item.Seats) || 0), 0);
            document.getElementById('stat-seats').innerText = totalSeats.toLocaleString();
            
            const totalAdmits = data.reduce((sum, item) => sum + (parseInt(item['Weekly Admissions']) || 0), 0);
            const avg = data.length ? Math.round(totalAdmits / data.length) : 0;
            document.getElementById('stat-avg-admit').innerText = avg.toLocaleString();

            const totalWeight = data.reduce((sum, item) => {
                let val = item.Weight ? item.Weight.replace(/[£,]/g, '') : "0";
                return sum + (parseFloat(val) || 0);
            }, 0);
            document.getElementById('stat-weight').innerText = "£" + totalWeight.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});

            const uniqueRegions = [...new Set(data.map(d => d['Macro Trading Region']))].filter(Boolean).sort();
            document.getElementById('stat-regions').innerText = uniqueRegions.length > 0 ? uniqueRegions.join(', ') : '-';
        }

        function updateList(data) {
            const container = document.getElementById('list-container');
            container.innerHTML = "";
            data.slice(0, 100).forEach(item => {
                const color = getBrandColor(item.Exhibitor);
                const d = document.createElement('div');
                d.className = 'list-item';
                d.innerHTML = `
                    <span class="dot" style="background:${color}"></span>
                    <div style="width:100%">
                        <div style="display:flex; justify-content:space-between;">
                             <div style="font-weight:600; font-size:0.85rem; color:#fff;">${item.Site}</div>
                             <div style="font-size:0.75rem; color:#888;">${(parseInt(item['Weekly Admissions'])||0).toLocaleString()}</div>
                        </div>
                        <div style="font-size:0.75rem; color:#666;">${item.Exhibitor}</div>
                    </div>
                `;
                d.onclick = () => { map.flyTo([item.Latitude, item.Longitude], 15); };
                container.appendChild(d);
            });
        }

        function populateDropdowns() {
            const exSel = document.getElementById('exhibitor-filter');
            exSel.innerHTML = '<option value="All">All Exhibitors</option>';
            [...new Set(allData.map(d => d.Exhibitor))].sort().forEach(x => { if(x) exSel.appendChild(new Option(x, x)); });
            const regSel = document.getElementById('region-filter');
            regSel.innerHTML = '<option value="All">All Regions</option>';
            [...new Set(allData.map(d => d['Macro Trading Region']))].filter(Boolean).sort().forEach(x => { if(x) regSel.appendChild(new Option(x, x)); });
        }

        function applyFilters() {
            const exVal = document.getElementById('exhibitor-filter').value;
            const regVal = document.getElementById('region-filter').value;
            filteredData = allData.filter(item => {
                if (exVal !== "All" && item.Exhibitor !== exVal) return false;
                if (regVal !== "All" && item['Macro Trading Region'] !== regVal) return false;
                if (userCircle) {
                    const d = getDist(userCircle.getLatLng().lat, userCircle.getLatLng().lng, item.Latitude, item.Longitude);
                    if (d > (userCircle.getRadius()/1000)) return false;
                }
                return true;
            });
            updateMap(filteredData, true); 
        }

        async function performSearch() {
            const pc = document.getElementById('postcode').value;
            if(!pc) return;
            if (pc === "Pinned Location" && lastClickedCoords) { runRadiusSearch(lastClickedCoords.lat, lastClickedCoords.lng); return; }
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${pc}, UK`);
                const json = await res.json();
                if(!json.length) return alert("Postcode not found");
                lastClickedCoords = null; 
                runRadiusSearch(parseFloat(json[0].lat), parseFloat(json[0].lon));
            } catch(e) { alert("Search Error"); }
        }

        function runRadiusSearch(lat, lng) {
            const inputVal = parseFloat(document.getElementById('radius').value);
            const unit = document.getElementById('radius-unit').value;
            let radiusKm = inputVal;
            if (unit === 'miles') radiusKm = inputVal * 1.60934;
            else if (unit === 'walk') radiusKm = 5 * (inputVal / 60);
            else if (unit === 'drive') radiusKm = (35 * (inputVal / 60)) / 1.3; 
            if(userCircle) map.removeLayer(userCircle);
            userCircle = L.circle([lat, lng], { color: '#4facfe', fillColor: '#4facfe', fillOpacity: 0.15, weight: 1, radius: radiusKm * 1000 }).addTo(map);
            applyFilters();
        }

        function resetView() {
            if(userCircle) map.removeLayer(userCircle);
            userCircle = null; lastClickedCoords = null;
            document.getElementById('postcode').value = "";
            document.getElementById('exhibitor-filter').value = "All";
            document.getElementById('region-filter').value = "All";
            filteredData = allData;
            updateMap(allData, true); 
        }

        function getDist(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function exportData() {
            const csv = Papa.unparse(filteredData);
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
            link.download = "DCM_Estate_Export.csv";
            link.click();
        }
    </script>
</body>
</html>